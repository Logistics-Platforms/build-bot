name: Build
description: "Builds the application for the specified platform"
inputs:
  node-version:
    description: "Node.js version to use"
    required: false
    default: "18"
  platform:
    description: "Platform to build (ios or android)"
    required: true
  profile:
    description: "Profile to build (development, preview, production)"
    required: true
  build-tag:
    description: "Tag to build"
    required: true
  build-type:
    description: "Type of build (ipa, apk, aab)"
    required: true
  expo-token:
    description: "Expo token to use"
    required: true
  cache-key:
    description: "Cache key to use"
    required: true
  cache-hit:
    description: "Whether cache was hit in previous job"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: ðŸ”¨ Restore Dependencies
      uses: actions/cache/restore@v4
      with:
        path: node_modules
        key: ${{ inputs.cache-key }}

    - name: ðŸ”¨ Install Dependencies
      shell: bash
      run: yarn install
    
    - name: ðŸ”¨ Setup EAS
      uses: expo/expo-github-action@v8
      with:
        expo-version: "latest"
        token: ${{ inputs.expo-token }}

    - name: ðŸ”¨ Select Xcode
      if: ${{ inputs.platform == 'ios' }}
      shell: bash
      run: sudo xcode-select --switch /Applications/Xcode_16.4.app

    - name: ðŸ”¨ Parse App version and number
      shell: bash
      run: fastlane parse_version_tag tag:${{ inputs.build-tag }}

    - name: ðŸ”¨ Building ${{ inputs.platform }}
      shell: bash
      run: fastlane ${{ inputs.platform }} build profile:${{ inputs.profile }}

    - name: ðŸ“¦ Upload ${{ inputs.platform }} Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.platform }}-${{ inputs.build-type }}-${{ inputs.build-tag }}
        path: |
          **/*.${{ inputs.build-type }}
        retention-days: 30
        if-no-files-found: error

    # - name: Restore cache
    #   if: inputs.cache-hit == 'true'
    #   uses: actions/cache@v3
    #   with:
    #     path: |
    #       node_modules
    #       ~/.npm
    #     key: ${{ runner.os }}-cache-${{ hashFiles('**/package-lock.json') }}
    #     restore-keys: |
    #       ${{ runner.os }}-cache-

    # - name: Install dependencies
    #   if: inputs.cache-hit != 'true'
    #   shell: bash
    #   run: npm ci

    - name: Build ${{ inputs.platform }}
      shell: bash
      run: |
        echo "Building ${{ inputs.platform }} application..."
        # Add your build commands here
        # npm run build:${{ inputs.platform }}

    # - name: Upload ${{ inputs.platform }} artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: ${{ inputs.platform }}-build
    #     path: |
    #       build/${{ inputs.platform }}
    #       # Adjust path to your build output
