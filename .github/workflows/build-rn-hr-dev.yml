name: Build Talent App Development

on:
  repository_dispatch:
    types:
      - TalentHR-development-*

env:
  LANG: en_US.UTF-8
  RUBY_VERSION: 3.0.0
  ENVIRONMENT: development
  REF_NAME: ${{ github.event.client_payload.ref_name }}
  FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
  FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
  FASTLANE_SESSION: ${{ secrets.FASTLANE_SESSION }}
  FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}

jobs:
  check-cache:
    name: Check Cache ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "macos-latest"
            os: "macos"

          - name: "ubuntu-latest"
            os: "ubuntu"

    runs-on: ${{matrix.name}}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MAIN_REPOSITORY }}
          token: ${{ secrets.PUBLIC_REPO_PAT }}
          ref: ${{ env.REF_NAME }}

      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: ${{matrix.os}}-node-modules-${{ hashFiles('yarn.lock') }}

      - name: Install Node Modules
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: yarn install

  build:
    name: Build ${{matrix.platform}}
    needs: [check-cache]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "macos-15"
            os: "macos"
            profile: development
            platform: "ios"
            type: ipa

          - name: "ubuntu-latest"
            os: "ubuntu"
            profile: development
            platform: "android"
            type: apk

    runs-on: ${{matrix.name}}
    steps:
      - name: ðŸ”¨ Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MAIN_REPOSITORY }}
          token: ${{ secrets.PUBLIC_REPO_PAT }}
          ref: ${{ env.REF_NAME }}

      - name: ðŸ”¨ Restore Dependencies
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: ${{matrix.os}}-node-modules-${{ hashFiles('yarn.lock') }}

      - name: ðŸ”¨ Install Dependencies
        run: yarn install

      - name: ðŸ”¨ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: "latest"
          token: ${{ secrets.EXPO_CLI_TOKEN }}

      - name: ðŸ”¨ Select Xcode
        if: ${{matrix.os == 'macos'}}
        run: sudo xcode-select --switch /Applications/Xcode_16.4.app

      - name: ðŸ”¨ Load Environment
        run: yarn load:env --profile ${{ matrix.profile }}

      - name: ðŸ”¨ Load App version and number
        run: yarn load:version ${{ env.REF_NAME }}

      - name: ðŸ”¨ Building ${{ matrix.platform }} with environment ${{ env.ENVIRONMENT }}
        run: yarn build:app --platform ${{ matrix.platform }} --profile ${{ matrix.profile }}

      - name: ðŸ“¦ Upload ${{ matrix.platform }} Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.type }}-${{ env.REF_NAME }}
          path: |
            **/*.${{ matrix.type }}
          retention-days: 30
          if-no-files-found: error

      - name: ðŸŽ‰ Distribute ${{matrix.platform}} App!
        run: yarn delivery:app --platform ${{ matrix.platform }} --profile ${{ matrix.profile }}
