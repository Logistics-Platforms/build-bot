name: Build Talent App Development

on:
  repository_dispatch:
    types:
      - TalentHR-development-*

env:
  LANG: en_US.UTF-8
  RUBY_VERSION: 3.0.0
  PROFILE: development
  REF_NAME: ${{ github.event.client_payload.ref_name }}

jobs:
  check-cache:
    name: Check Cache
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MAIN_REPOSITORY }}
          token: ${{ secrets.PUBLIC_REPO_PAT }}
          ref: ${{ env.REF_NAME }}

      - name: Cache Node Modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('yarn.lock') }}

      - name: Install Node Modules
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: yarn install

  build:
    name: Build ${{matrix.platform}}
    needs: [check-cache]
    strategy:
      fail-fast: true
      matrix:
        include:
          - name: "macos-14"
            platform: "ios"
            type: ipa
          # - name: "ubuntu-22.04"
          #   platform: "android"
          #   type: apk

    runs-on: "macos-14"
    steps:
      - name: ðŸ”¨ Checkout Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.MAIN_REPOSITORY }}
          token: ${{ secrets.PUBLIC_REPO_PAT }}
          ref: ${{ env.REF_NAME }}

      - name: ðŸ”¨ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: ðŸ”¨ Setup Ruby ${{env.RUBY_VERSION}}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{env.RUBY_VERSION}}
          bundler-cache: true

      # - name: ðŸ”¨ Setup cocoapods
      #   if: matrix.platform == 'ios'
      #   uses: maxim-lobanov/setup-cocoapods@v1
      #   with:
      #     version: 1.14.3

      # - name: ðŸ”¨ Install Vendor
      #   run: bundle install

      - name: ðŸ”¨ Install Dependencies
        uses: actions/cache/restore@v4
        with:
          path: node_modules
          key: node-modules-${{ hashFiles('yarn.lock') }}

      - name: ðŸ”¨ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: "latest"
          token: ${{ secrets.EXPO_CLI_TOKEN }}

      # - name: ðŸ”¨ Configuring Env from Expo Server
      #   shell: bash
      #   run: bash scripts/load-expo-env.sh ${{ env.PROFILE }}
      # - name: ðŸ”¨ Configuring Build Version and Number
      #   shell: bash
      #   run: bash scripts/load-build-version-number.sh
      # - name: ðŸ”¨ Configuring Secret File
      #   run: bash scripts/load-secret-file.sh
      # - name: ðŸ”¨ Prebuild Native Code
      #   run: yarn prebuild --platform ${{ matrix.platform }}
      - name: ðŸ”¨ Building ${{ matrix.platform }} with environment ${{ env.PROFILE }}
        run: fastlane ${{ matrix.platform }} build profile:${{ env.PROFILE }}
        # run: bash scripts/eas/eas-build-local.sh ${{ matrix.platform }} ${{ env.PROFILE }}

      # - name: ðŸŽ‰ Delivery ${{matrix.platform}} App!
      #   run: bash scripts/delivery.sh ${{ matrix.platform }} ${{ env.PROFILE }}
