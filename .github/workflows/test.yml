name: Manual Build and deploy DEV Portal

on:
    workflow_dispatch:

jobs:
    check-cache:
        name: Check Cache
        runs-on: ubuntu-latest
        outputs:
            cache-hit: ${{ steps.cache-check.outputs.cache-hit }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            - name: Cache dependencies
              id: cache-check
              uses: actions/cache@v3
              with:
                  path: |
                      node_modules
                      ~/.npm
                  key: ${{ runner.os }}-cache-${{ hashFiles('**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-cache-

            - name: Test
              run: echo "Run Cache Check"

    build:
        name: Build ${{ matrix.platform }}
        runs-on: ubuntu-latest
        needs: check-cache
        strategy:
            matrix:
                platform: [ios, android]
            fail-fast: false # Allow other platforms to continue if one fails
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18"

            # - name: Restore cache
            #   uses: actions/cache@v3
            #   with:
            #       path: |
            #           node_modules
            #           ~/.npm
            #       key: ${{ runner.os }}-cache-${{ hashFiles('**/package-lock.json') }}
            #       restore-keys: |
            #           ${{ runner.os }}-cache-

            # - name: Install dependencies
            #   if: needs.check-cache.outputs.cache-hit != 'true'
            #   run: npm ci

            - name: Build ${{ matrix.platform }}
              run: |
                  echo "Building ${{ matrix.platform }} application..."
                  # Add your build commands here
                  # npm run build:${{ matrix.platform }}

            # - name: Upload ${{ matrix.platform }} artifact
            #   uses: actions/upload-artifact@v4
            #   with:
            #       name: ${{ matrix.platform }}-build
            #       path: |
            #           build/${{ matrix.platform }}
            #           # Adjust path to your build output

    deploy:
        name: Deploy ${{ matrix.platform }}
        runs-on: ubuntu-latest
        needs: build
        if: ${{ !cancelled() }} # Run even if some builds failed
        strategy:
            matrix:
                platform: [ios, android]
            fail-fast: false
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # - name: Download ${{ matrix.platform }} artifact
            #   uses: actions/download-artifact@v4
            #   with:
            #       name: ${{ matrix.platform }}-build
            #       path: build/${{ matrix.platform }}

            - name: Deploy ${{ matrix.platform }}
              run: |
                  echo "Deploying ${{ matrix.platform }} application..."
                  # Add your deployment commands here
                  # fastlane ${{ matrix.platform }} deploy
